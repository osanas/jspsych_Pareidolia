<!DOCTYPE html>
<html>

<head>
  <script src="dist/jspsych.js"></script>
  <script src="dist/plugin-fullscreen.js"></script>
  <script src="dist/plugin-html-button-response.js"></script>
  <script src="dist/plugin-html-keyboard-response.js"></script>
  <script src="dist/plugin-survey-text.js"></script>
  <script src="dist/plugin-webgazer-init-camera.js"></script>
  <script src="dist/plugin-webgazer-calibrate.js"></script>
  <script src="dist/plugin-webgazer-validate.js"></script>
  <script src="js/webgazer/webgazer.js"></script>
  <script src="dist/extension-webgazer.js"></script>
  <link rel="stylesheet" href="dist/jspsych.css">
</head>
<style>
  .jspsych-content {
    max-width: 100%;
  }
</style>

<body></body>
<script>
  // preloading videos only works when the file is running on a server
  // if you run this experiment by opening the file directly in the browser,
  // then video preloading will be disabled to prevent CORS errors
  var fullscreen = {
    type: jsPsychFullscreen,
    fullscreen_mode: true
  };

  var Hello = {
    type: jsPsychHtmlButtonResponse,
    stimulus: '<div style="max-width:600px;"><p>Bonjour ! bla bla bla.</p></div>',
    choices: ['continue']
  };

  var camera_instructions = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
        <p>This experiment uses your camera for eye tracking.</p>
        <p>In order to participate you must allow the experiment to use your camera.</p>
        <p>You will be prompted to do this on the next screen.</p>
        <p>If you do not want to permit the experiment to use your camera, please close the page.</p>
      `,
    choices: ['Click to begin'],
    post_trial_gap: 1000
  };

  var init_camera = {
    type: jsPsychWebgazerInitCamera
  };

  var calibration_instructions = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
        <p>Great! Now the eye tracker will be calibrated to translate the image of your eyes from the webcam to a location on your screen.</p>
        <p>To do this, you need to click a series of dots.</p>
        <p>Keep your head still, and click on each dot as it appears. Look at the dot as you click it.</p>
      `,
    choices: ['Click to begin'],
    post_trial_gap: 1000
  };

  var calibration = {
    type: jsPsychWebgazerCalibrate,
    calibration_points: [[50, 50], [25, 25], [25, 75], [75, 25], [75, 75]],
    //calibration_points: [[10,10],[10,30],[10,50],[10,70],[10,90],[30,10],[30,30],[30,50],[30,70],[30,90],[50,10],[50,30],[50,50],[50,70],[50,90],[70,10],[70,30],[70,50],[70,70],[70,90],[90,10],[90,30],[90,50],[90,70],[90,90]],
    // calibration_points: [
    //   [10,10],[10,50],[10,90],
    //   [30,10],[30,50],[30,90],
    //   [40,10],[40,30],[40,40],[40,45],[40,50],[40,55],[40,60],[40,70],[40,90],
    //   [50,10],[50,30],[50,40],[50,45],[50,50],[50,55],[50,60],[50,70],[50,90],
    //   [60,10],[60,30],[60,40],[60,45],[60,50],[60,55],[60,60],[60,70],[60,90],
    //   [70,10],[70,50],[70,90],
    //   [90,10],[90,50],[90,90]],
    repetitions_per_point: 2,
    randomize_calibration_order: true,
  };

  var validation_instructions = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
        <p>Let's see how accurate the eye tracking is. </p>
        <p>Keep your head still, and move your eyes to focus on each dot as it appears.</p>
        <p>You do not need to click on the dots. Just move your eyes to look at the dots.</p>
      `,
    choices: ['Click to begin'],
    post_trial_gap: 1000
  };

  var validation = {
    type: jsPsychWebgazerValidate,
    validation_points: [[25, 25], [25, 75], [75, 25], [75, 75]],
    show_validation_data: true
  };


  var pareidolia_instructions = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
        <p>In the next part of the experiment, you will see a series of images. Some images may seem like random patterns, but they may also evoke some forms or entities. Your task is to identify and name these entities if you see any. You will have 10 seconds to look at each image. If you recognize something before 10 seconds, press the space bar. Afterward, you will be asked to input up to 3 words that describe what you saw in the image.</p>
      `,
    choices: ['Click to begin'],
    post_trial_gap: 1000
  };

  function getImage() {

    // Call Api GetImage();

    var list_img =
      ['https://www.laboiteverte.fr/wp-content/uploads/2014/03/Pareidolie-Visage-Objet-01.jpg',
        'https://emag.magmalemag.com/upload/remuemeninges/5-la-pareidolie-ou-l-art-de-174521-26.51.19.jpg'];

    var randomIndex = Math.floor(Math.random() * list_img.length);
    return list_img[randomIndex];
  }

  var Experiment = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: function () {
      var url_img = getImage();
      randomimg = '<img src="' + url_img + '">'; 
      return randomimg;
    },
    choices: [' '],
    trial_duration: 3000,
    response_ends_trial: false,
    on_start: function(trial) {
      trial.data = { onset_time: jsPsych.getTotalTime() };
    },
    on_finish: function(data) {
      data.offset_time = jsPsych.getTotalTime();
    }
  };

  var Words = {
    type: jsPsychSurveyText,
    questions: [
      { prompt: 'Word 1', columns: 3, required: false, name: 'word1' },
      { prompt: 'Word 2', columns: 3, required: false, name: 'word2' },
      { prompt: 'Word 3', columns: 3, required: false, name: 'word3' }
    ],
    randomize_question_order: false,
    conditional_function: function () {
      var last_trial_data = jsPsych.data.getLastTrialData().values()[0];
      return last_trial_data.key_press !== null;  // Only display the text boxes if the space bar was pressed in the last trial
    }
  };

  var n_back_sequence = {
    timeline: [Experiment, Words],
    // timeline_variables:
    repetitions: 3
  }

  var DAT_instructions = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
        <p>Please enter 10 words that are as different from each other as possible, in all meanings and uses of the words.</p>
        <p>RULES:</p>
        <p>1. Only single words in English.</p>
        <p>2. Only nouns (e.g., things, objects, concepts).</p>
        <p>3. No proper nouns (e.g., no specific people or places).</p>
        <p>4. No specialised vocabulary (e.g., no technical terms).</p>
        <p>5. Think of the words on your own (e.g., do not just look at objects in your surroundings).</p>
        `,
    choices: ['Click to begin'],
    post_trial_gap: 1000
  };

  var DAT_test = {
    type: jsPsychSurveyText,
    questions: [
      { prompt: 'Word 1', columns: 20, required: true, name: 'word1' },
      { prompt: 'Word 2', columns: 20, required: true, name: 'word2' },
      { prompt: 'Word 3', columns: 20, required: true, name: 'word3' },
      { prompt: 'Word 4', columns: 20, required: true, name: 'word4' },
      { prompt: 'Word 5', columns: 20, required: true, name: 'word5' },
      { prompt: 'Word 6', columns: 20, required: true, name: 'word6' },
      { prompt: 'Word 7', columns: 20, required: true, name: 'word7' },
      { prompt: 'Word 8', columns: 20, required: true, name: 'word8' },
      { prompt: 'Word 9', columns: 20, required: true, name: 'word9' },
      { prompt: 'Word 10', columns: 20, required: true, name: 'word10' }
    ],
    randomize_question_order: false
  };

  var done = {
    type: jsPsychHtmlButtonResponse,
    choices: ['CSV', 'JSON'],
    stimulus: `<p>Done!</p><p>If you'd like to download a copy of the data to explore, click the format you'd like below</p>`,
    on_finish: function (data) {
      if (data.response == 0) {
        jsPsych.data.get().localSave('csv', 'webgazer-sample-data.csv');
      }
      if (data.response == 1) {
        jsPsych.data.get().localSave('json', 'webgazer-sample-data.json');
      }
    }
  };

  var jsPsych = initJsPsych({
    on_finish: function () {
      jsPsych.data.displayData();
    },
    extensions: [
      { type: jsPsychExtensionWebgazer }
    ]
  });
  var timeline = [];
  // timeline.push(camera_instructions);
  // timeline.push(init_camera);
  // timeline.push(calibration_instructions);
  // timeline.push(calibration);
  // timeline.push(validation_instructions);
  // timeline.push(validation);

  timeline.push(n_back_sequence);

  // Second task
  // timeline.push(DAT_instructions);
  // timeline.push(DAT_test);
  timeline.push(done);
  jsPsych.run(timeline);

</script>

</html>
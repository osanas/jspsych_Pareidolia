<!DOCTYPE html>
<html>

<head>
  <script src="dist/jspsych.js"></script>
  <script src="dist/plugin-fullscreen.js"></script>
  <script src="dist/plugin-html-button-response.js"></script>
  <script src="dist/plugin-html-keyboard-response.js"></script>
  <script src="dist/plugin-survey-text.js"></script>
  <script src="dist/plugin-webgazer-init-camera.js"></script>
  <script src="dist/plugin-webgazer-calibrate.js"></script>
  <script src="dist/plugin-webgazer-validate.js"></script>
  <script src="js/webgazer/webgazer.js"></script>
  <script src="dist/extension-webgazer.js"></script>
  <link rel="stylesheet" href="dist/jspsych.css">
</head>
<style>
  .jspsych-content {
    max-width: 100%;
  }
</style>

<body></body>
<script>

  // preloading videos only works when the file is running on a server
  // if you run this experiment by opening the file directly in the browser,
  // then video preloading will be disabled to prevent CORS errors

  function getRandomImagesFromFolder(FD, count) {
    // Assuming you have up to 100 images in each folder. Adjust this number if necessary.
    const totalImagesInFolder = 100;
    const selectedIndices = [];
    while (selectedIndices.length < count) {
      const randomIndex = Math.floor(Math.random() * totalImagesInFolder) + 1;
      if (!selectedIndices.includes(randomIndex)) {
        selectedIndices.push(randomIndex);
      }
    }
    return selectedIndices.map(index => `images/FD${FD}/FD_${FD}_${index}.png`); // Change the filename format if necessary.
  }

  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  const ageVal = null;
  const nationalityVal = null;
  const selectedLanguage = null;

  const fd12Images = getRandomImagesFromFolder('12', 10);
  const fd14Images = getRandomImagesFromFolder('14', 10);
  const fd16Images = getRandomImagesFromFolder('16', 10);

  const image_list = [...fd12Images, ...fd14Images, ...fd16Images];
  shuffleArray(image_list);

  ////////////// Start //////////////

  var fullscreen = {
    type: jsPsychFullscreen,
    fullscreen_mode: true
  };

  var research_info = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <div style="max-width:900px; font-size: 16px; line-height: 1.5;">
        <p style="margin-bottom: 20px;">Welcome to this research!</p>
        
        <p style="margin-bottom: 20px;">By participating, you agree to the following:</p>
        
        <ul style="margin-bottom: 20px;">
          <li style="margin-bottom: 10px;">The data collected will be used exclusively for academic and research purposes.</li>
          <li style="margin-bottom: 10px;">Your data will be anonymized and won't be associated with any personal identifiers.</li>
          <li style="margin-bottom: 10px;">The experiment consists of 2 short tasks. The first involves looking at ambiguous images. The second consist in providing semantically distant words.</li>
          <li>You can terminate your participation at any time.</li>
        </ul>
        
        <p style="margin-top: 20px;">Press the 'X' key to confirm and continue.</p>
      </div>
    `,
    choices: ['x']
  };

  var demographic_questions = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
        <div style="max-width:600px;">
            <p>Please answer the following demographic questions:</p>
            
            <label for="ageInput">What is your age?</label>
            <input type="number" id="ageInput" name="age" min="1" required><br><br>

            <label for="nationalityInput">What is your nationality?</label>
            <input type="text" id="nationalityInput" name="nationality" placeholder="e.g. American" required><br><br>

            <label for="languageSelect">What is your primary language?</label>
            <select id="languageSelect" name="primary_language">
                <option value="English">English</option>
                <option value="Spanish">Spanish</option>
                <option value="Chinese">Chinese</option>
                <option value="Hindi">Hindi</option>
                <option value="Arabic">Arabic</option>
                <option value="Bengali">Bengali</option>
                <option value="Portuguese">Portuguese</option>
                <option value="Russian">Russian</option>
                <option value="Japanese">Japanese</option>
                <option value="Punjabi">Punjabi</option>
                <option value="Javanese">Javanese</option>
                <option value="Malay">Malay</option>
                <option value="Telugu">Telugu</option>
                <option value="Vietnamese">Vietnamese</option>
                <option value="Korean">Korean</option>
                <option value="French">French</option>
                <option value="German">German</option>
                <option value="Italian">Italian</option>
                <option value="Dutch">Dutch</option>
                <option value="Greek">Greek</option>
                <option value="Other">Other</option>
            </select><br><br>
        </div>
    `,
    choices: ['Continue'],
    button_html: '<button class="jspsych-btn" disabled id="continueButton">%choice%</button>',
    on_load: function () {
      function enableIfCompleted() {
        ageVal = document.getElementById('ageInput').value;
        nationalityVal = document.getElementById('nationalityInput').value;
        selectedLanguage = document.getElementById('languageSelect').value;

        if (ageVal && nationalityVal && selectedLanguage) {
          document.getElementById('continueButton').disabled = false;
        }
      }

      document.getElementById('ageInput').addEventListener('input', enableIfCompleted);
      document.getElementById('nationalityInput').addEventListener('input', enableIfCompleted);
      document.getElementById('languageSelect').addEventListener('change', enableIfCompleted);
    },
    on_finish: function (trial) {
      console.log(trial);
      //let responses = JSON.parse(data.responses);
      trial.data = ({
        age: ageVal,
        nationality: nationalityVal,
        primary_language: selectedLanguage
      });
    }
  };

  var camera_instructions = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
        <p>This experiment uses your camera for eye tracking.</p>
        <p>In order to participate you must allow the experiment to use your camera.</p>
        <p>You will be prompted to do this on the next screen.</p>
        <p>If you do not want to permit the experiment to use your camera, please close the page.</p>
      `,
    choices: ['Click to begin'],
    post_trial_gap: 1000
  };

  var init_camera = {
    type: jsPsychWebgazerInitCamera
  };

  var calibration_instructions = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
        <p>Great! Now the eye tracker will be calibrated to translate the image of your eyes from the webcam to a location on your screen.</p>
        <p>To do this, you need to click a series of dots.</p>
        <p>Keep your head still, and click on each dot as it appears. Look at the dot as you click it.</p>
      `,
    choices: ['Click to begin'],
    post_trial_gap: 1000
  };

  var calibration = {
    type: jsPsychWebgazerCalibrate,
    calibration_points: [[50, 50], [25, 25], [25, 75], [75, 25], [75, 75]],
    repetitions_per_point: 2,
    randomize_calibration_order: true,
  };

  var validation_instructions = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
        <p>Let's see how accurate the eye tracking is. </p>
        <p>Keep your head still, and move your eyes to focus on each dot as it appears.</p>
        <p>You do not need to click on the dots. Just move your eyes to look at the dots.</p>
      `,
    choices: ['Click to begin'],
    post_trial_gap: 1000
  };

  var validation = {
    type: jsPsychWebgazerValidate,
    validation_points: [[25, 25], [25, 75], [75, 25], [75, 75]],
    show_validation_data: true
  };

  var pareidolia_instructions = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
        <p>In the next part of the experiment, you will see a series of images. Some images may seem like random patterns, but they may also evoke some forms or entities. Your task is to identify and name these entities if you see any. You will have 10 seconds to look at each image. If you recognize something before 10 seconds, press the space bar. Afterward, you will be asked to input up to 3 words that describe what you saw in the image.</p>
      `,
    choices: ['Click to begin']
  };

  var Experiment = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: function () {
      var url_img = get_sample_image();
      randomimg = '<img src="' + url_img + '">';
      return randomimg;
    },
    choices: [' '],
    trial_duration: 3000,
    response_ends_trial: false,
    on_start: function (trial) {
      trial.data = { onset_time: jsPsych.getTotalTime() };
    },
    on_finish: function (data) {
      data.offset_time = jsPsych.getTotalTime();
    },
    trial_duration: 3000,  // 3 seconds
    response_ends_trial: false,  // This will end the trial once the space bar is pressed
    post_trial_gap: 100,
    extensions: [
      {
        type: jsPsychExtensionWebgazer,
        params: { targets: ['#jspsych-image-keyboard-response-stimulus'] }
      }
    ]
  };

  var Words = {
    type: jsPsychSurveyText,
    questions: [
      { prompt: 'Word 1', columns: 3, required: false, name: 'word1' },
      { prompt: 'Word 2', columns: 3, required: false, name: 'word2' },
      { prompt: 'Word 3', columns: 3, required: false, name: 'word3' }
    ],
    randomize_question_order: false,
    conditional_function: function () {
      var last_trial_data = jsPsych.data.getLastTrialData().values()[0];
      return last_trial_data.key_press !== null;  // Only display the text boxes if the space bar was pressed in the last trial
    },
    post_trial_gap: 100
  };

  var n_back_sequence = {
    timeline: [Experiment, Words],
    // timeline_variables:
    repetitions: 3
  }

  var DAT_instructions = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
        <p>Please enter 10 words that are as different from each other as possible, in all meanings and uses of the words.</p>
        <p>RULES:</p>
        <p>1. Only single words in English.</p>
        <p>2. Only nouns (e.g., things, objects, concepts).</p>
        <p>3. No proper nouns (e.g., no specific people or places).</p>
        <p>4. No specialised vocabulary (e.g., no technical terms).</p>
        <p>5. Think of the words on your own (e.g., do not just look at objects in your surroundings).</p>
        `,
    choices: ['Click to begin'],
    post_trial_gap: 1000
  };

  var DAT_test = {
    type: jsPsychSurveyText,
    questions: [
      { prompt: 'Word 1', columns: 20, required: true, name: 'word1' },
      { prompt: 'Word 2', columns: 20, required: true, name: 'word2' },
      { prompt: 'Word 3', columns: 20, required: true, name: 'word3' },
      { prompt: 'Word 4', columns: 20, required: true, name: 'word4' },
      { prompt: 'Word 5', columns: 20, required: true, name: 'word5' },
      { prompt: 'Word 6', columns: 20, required: true, name: 'word6' },
      { prompt: 'Word 7', columns: 20, required: true, name: 'word7' },
      { prompt: 'Word 8', columns: 20, required: true, name: 'word8' },
      { prompt: 'Word 9', columns: 20, required: true, name: 'word9' },
      { prompt: 'Word 10', columns: 20, required: true, name: 'word10' }
    ],
    randomize_question_order: false
  };

  var done = {
    type: jsPsychHtmlButtonResponse,
    choices: ['CSV', 'JSON'],
    stimulus: `<p>Done!</p><p>If you'd like to download a copy of the data to explore, click the format you'd like below</p>`,
    on_finish: function (data) {
      var all_data = jsPsych.data.get();
      post_sample_data(all_data);
      if (data.response == 0) {
        jsPsych.data.get().localSave('csv', 'webgazer-sample-data.csv');
      }
      if (data.response == 1) {
        jsPsych.data.get().localSave('json', 'webgazer-sample-data.json');
      }
    }
  };

  // API
  function post_sample_data(data) {
    $.ajax({
      type: "POST",
      url: "api_post_data.php",
      data: "data=name&location=location",
      success: function (msg) {
        alert("Data Saved: " + msg);
      }
    });
  }
  // Options de la requête
  const requestOptions = {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json', // Indique que vous envoyez des données JSON
    },
    body: JSON.stringify(jsonData), // Convertit les données JSON en chaîne
  };
  const url = 'api_post_data.php';

  function get_sample_image() {
    var randomIndex = Math.floor(Math.random() * image_list.length);
    var url = image_list[randomIndex];
    // delete the image from the list
    image_list.splice(randomIndex, 1);
    return url;
  }

  var jsPsych = initJsPsych({
    on_finish: function () {
      jsPsych.data.displayData();
    },
    extensions: [
      { type: jsPsychExtensionWebgazer }
    ]
  });
  var timeline = [];

  timeline.push(camera_instructions);
  timeline.push(init_camera);
  timeline.push(calibration_instructions);
  timeline.push(calibration);
  timeline.push(validation_instructions);
  timeline.push(validation);

  timeline.push(n_back_sequence);

  // Second task
  // timeline.push(DAT_instructions);
  // timeline.push(DAT_test);
  timeline.push(done);
  jsPsych.run(timeline);

</script>

</html>